
<html>
<script>
var canvas;	
var ctx; // context	
var row, col; // say coordinates
var socket;

function drawText( parameter )
{
      
      var context = ctx;
   
      if( context ) 
      {
      	 ctx.fillStyle = '#0f0';
         ctx.font      = '20px verdana';
         context.fillText( parameter.text, parameter.row, parameter.col );
      }
   
}

function connect()
{
   try
   {
      socket = new WebSocket( "ws://localhost:2000/harbour" );

      socket.onopen = function( event )
      {
//         Say( "Connected" );
      }
      socket.onmessage = function( msg )
      {
      	var JSON = eval ("(" + msg.data + ")");
      	try
      	{
      	   eval( JSON.function )( JSON.parameter );
      	}catch( oError )
      	{
      	   send( "Error on Message" );
      	}
      	
      }
      
      socket.onclose = function( event )
      {
         //Say( "connection closed from the server" );
      }
      socket.onerror = function()
      {
         Say( "Error: " + socket.readyState );
      }
   }
   catch( exception )
   {
      Say( "Exception ocurred" );
   }
}
function Send( text )
{
   try
   {
      socket.send( text );
   }
   catch( exception )
   {
      Say( "can't send to the server" );
   }
}

	
function Say( cText )
{
   if( row > canvas.height - 21 )
   {
   	  var oldCanvas = canvas.toDataURL();
   	  var img = new Image();
   	  
      canvas.height += 22;
      ctx = canvas.getContext( '2d' );
      ctx.fillStyle = '#0f0';
      ctx.font      = '20px verdana';
      ctx.textBaseline = 'top';
   	  img.src = oldCanvas; 
      img.onload = function() { ctx.drawImage( img, 0, 0 ); };   
      var t = document.getElementById('canvasContainer');
      t.scrollTop = t.scrollHeight;      
   }   	 
   ctx.fillText( cText, col, row );
   row += 22;

}   		
	
function init()
{
   canvas = document.getElementById( 'canvas' );
   ctx = canvas.getContext( '2d' );
   ctx.fillStyle = '#0f0';
   ctx.font      = '20px verdana';
   ctx.textBaseline = 'top';
   row = 0;
   col = 0;

   connect();
   
   document.getElementById( "command" ).focus();
}

function ProcessCommand( event )
{
   if( event.keyCode == 13 )
   {
   	  var edit = document.getElementById( "command" );
      if( edit.value.length == 0 )
         return; 
   	    
   	  Say( edit.value );  
   	  Send( edit.value );  
      edit.value = "";
   }   
}

window.onload = init;
</script>

<head>
</head>
<body>
<h1>HTML5 WebSockets Harbour server demo</h1>
<div id=canvasContainer style="width: 820px; height: 570px; overflow: auto;">
<canvas id="canvas" width="800" height="570" style="background-color:#000"></canvas>
</div>
<br>
</body>
</html>

